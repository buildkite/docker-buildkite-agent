FROM gliderlabs/alpine:edge
MAINTAINER Tim Lucas <tim@buildkite.com>

ARG BUILDKITE_AGENT_VERSION=stable

LABEL com.buildkite.distro="alpine" \
    com.buildkite.version=${BUILDKITE_AGENT_VERSION} \
    com.buildkite.docker_version=1.9.1 \
    com.buildkite.docker_compose_version=1.5.1

RUN apk add --update --repository http://dl-1.alpinelinux.org/alpine/edge/testing/ tini \
     && apk-install sudo curl wget bash git perl openssh-client py-pip py-yaml docker\<1.9.2 \
    && pip install -U pip docker-compose==1.5.1 \
    && rm -rf /tmp/* /root/.cache `find / -regex '.*\.py[co]'`

ENV BUILDKITE_AGENT_VERSION=${BUILDKITE_AGENT_VERSION} \
    BUILDKITE_BUILD_PATH=/buildkite/builds \
    BUILDKITE_HOOKS_PATH=/buildkite/hooks

COPY ./scripts/docker/entrypoint.sh ./assets/ssh-env-config.sh /usr/local/bin/
COPY ./assets/${BUILDKITE_AGENT_VERSION}-386 /buildkite
RUN ln -s /buildkite/buildkite-agent /usr/local/bin/buildkite-agent \
    && adduser -S buildkite-agent  \
    && chown -R buildkite-agent: /buildkite

ENTRYPOINT ["/usr/bin/tini", "-vg", "--", "/usr/local/bin/entrypoint.sh", "buildkite-agent"]
CMD ["start"]
